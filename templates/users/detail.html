{% extends "base.html" %}

{% block content %}
    <div class="container-fulid">
        <div class="row">
            <div class="col-xs-2"></div>
            <div class="col-xs-8">
                <div class="card">
                    <div class="col-xs-3" style="max-width: 200px">
                        <img src="{{ people.get_image_url }}" class="img-rounded img-header">
                    </div>
                    <div class="col-xs-9" style="margin-top: 30px">
                        <h1>{{ people.nickname }}<span
                                style="font-weight: 400; font-size: 18px">&nbsp;&nbsp;&nbsp;{{ people.intro }}</span>
                        </h1>
                        <div style="margin: 20px 0">
                            <p><i class="icon icon-leaf"></i>&nbsp;&nbsp;{{ people.work }}</p>
                            <p>
                                {% if people.sex == 'M' %}
                                    <i class="icon icon-mars"></i>
                                {% else %}
                                    <i class="icon icon-venus"></i>
                                {% endif %}
                                {% if user == people %}
                                    <a href="{% url 'users:profile' %}" class="Button Button-white" style="float: right">编辑个人资料</a>
                                {% else %}
                                    <button class="Button Button-white" style="float: right"><i
                                            class="icon icon-comments" onclick=""></i> 私信
                                    </button>
                                    {% if is_following %}
                                    <a href="{% url 'users:unfollow' people.id %}"><button class="Button Button-grey" onmouseenter="enter(this)" onmouseleave="leave(this)" style="float: right;width: 90px">
                                        已关注</button></a>
                                    {% else %}
                                    <a href="{% url 'users:follow' people.id %}"><button class="Button Button-blue" style="float: right;width: 90px"><i
                                            class="icon icon-plus"></i> 关注
                                    </button></a>
                                    {% endif %}
                                {% endif %}
                            </p>

                        </div>

                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-8">
                        {% if AnswerView %}
                        <div class="card" id="answers-list">
                            <div>
                                <a href="{% url 'users:answers' people.id %}" class="tab-link tab-active">回答 <span class="tab-num">{{ people.answers.count }}</span></a>
                                <a href="{% url 'users:asks' people.id %}" class="tab-link ">提问 <span class="tab-num">{{ people.asks.count }}</span></a>
                                <a href="{% url 'users:collections' people.id %}" class="tab-link">收藏 <span class="tab-num">0</span></a>
                                <a href="{% url 'users:following' people.id %}" class="tab-link">关注 </a>
                            </div>
                            <div class="user-header">他的回答</div>
                            {% for answer in answers %}
                                <div style="border-top: solid 1px #f6f6f6">
                                    <div class="answer-ask-header"><a href="{% url 'asks:detail' answer.ask.id %}" style="color: black">{{ answer.ask.title }}</a></div>
                                    <div class="answer-card-header">
                                        <img src="{{ answer.author.get_image_url }}" class="img-rounded" width="38px"
                                             height="38px">
                                        <div class="user-info">
                                            <a href="{% url 'users:detail' answer.author.id %}" class="user-name">{{ answer.author.nickname }}</a>
                                            <div class="user-intro">{{ answer.author.intro }}</div>
                                        </div>
                                    </div>
                                    {% if answer.content_text|length < 180 %}
                                        <div class="answer-content">{{ answer.content|safe }}</div>
                                    {% else %}
                                        <div class="answer-content">
                                            <span>{{ answer.content_text|slice:':150'|safe }} ...</span>
                                            <button class="readmore" onclick="readmore(this, {{ answer.id }});return false">阅读全文 <i class="icon icon-angle-down"></i></button>
                                        </div>

                                    {% endif %}
                                    <div class="answer-footer" style="padding: 0 10px 10px 10px">
                                        {% if answer in vote_list %}
                                            <button class="vote" onclick="voteUp(this, {{ answer.id }})" hidden><i class="icon icon-caret-up"></i> {{ answer.votes }}</button>
                                            <button class="voted" onclick="voteDown(this, {{ answer.id }})"><i class="icon icon-caret-up"></i> {{ answer.votes }}</button>
                                        {% else %}
                                            <button class="vote" onclick="voteUp(this, {{ answer.id }})"><i class="icon icon-caret-up"></i> {{ answer.votes }}</button>
                                            <button class="voted" onclick="voteDown(this, {{ answer.id }})" hidden><i class="icon icon-caret-up"></i> {{ answer.votes }}</button>
                                        {% endif %}
                                        <button class="vote" onclick="return false"><i class="icon icon-caret-down"></i></button>
                                        <button class="footer-tab" onclick="showComments(this, {{ answer.id }})"><i class="icon icon-comment"></i> {{ answer.comments.count }}条评论</button>
                                        <button class="footer-tab" onclick="hideComments(this, {{ answer.id }})" hidden><i class="icon icon-comment"></i> 收起评论</button>
                                        <button class="footer-tab" onclick="return false"><i class="icon icon-share-alt"></i> 分享</button>
                                        {% if user.is_staff or user == answer.author %}
                                            <form style="display: inline" action="{% url 'answers:delete' pk=answer.id %}" method="post">{% csrf_token %}
                                                <button class="footer-tab" type="submit"><i class="icon icon-trash"></i> 删除</button>
                                            </form>
                                        {% endif %}


                                    </div>

                                    <div id="commentList-{{ answer.id }}" class="comments-container" hidden>
                                        <div class="user-header">{{ answer.comments.count }}条评论</div>

                                        <div id="replyEditor-{{ answer.id }}" class="comment-editor" style="padding: 0 0 5px;" hidden>
                                            <form style="display: flex" action="{% url 'comments:post_comment' pk=answer.id %}" method="post">
                                                {% csrf_token %}
                                                <textarea class="form-control" placeholder="评论" rows="1" name="content" required></textarea>
                                                <input name="reply_id" value="" type="hidden">
                                                <button class="Button Button-blue" style="margin-left: 10px; width: 80px;">评论</button>
                                            </form>
                                            <button class="footer-tab" onclick="cancelReply(this)" style="margin: 10px 0 0 0">&nbsp;&nbsp;&nbsp;取消</button>
                                        </div>

                                        {% for comment in answer.comments.all|dictsortreversed:'create_time' %}
                                            <div class="comment-item">
                                                <div class="commentItem-meta">
                                                    <span>
                                                        <img src="{{ comment.author.get_image_url }}" class="img-rounded" width="24px" height="24px">
                                                        <a style="color: black" href="{% url 'users:detail' comment.author.id %}">{{ comment.author.nickname }}</a>
                                                        {% if comment.reply_to %}
                                                            <span style="color: #8590a6">&nbsp;回复&nbsp;</span>
                                                            <a style="color: black" href="{% url 'users:detail' comment.reply_to.author.id %}">{{ comment.reply_to.author.nickname }}</a>
                                                        {% endif %}
                                                        <span class="datetime" style="float: right">{{ comment.create_time|timesince }}前</span>
                                                    </span>
                                                </div>
                                                <div class="commentItem-content">{{ comment.content }}</div>

                                                <button class="footer-tab reply-btn" onclick="reply(this, {{ answer.id }}, {{ comment.id }})" style="margin: 0"><i class="icon icon-share-alt"></i> 回复</button>
                                                {% if user.is_staff or user == comment.author or user == answer.author %}
                                                    <form style="display: inline" action="{% url 'comments:delete' pk=comment.id %}" method="post">{% csrf_token %}
                                                        <button class="footer-tab reply-btn" type="submit" style="margin: 0"><i class="icon icon-trash"></i> 删除</button>
                                                    </form>
                                                {% endif %}
                                            </div>

                                        {% endfor %}
                                        <div class="comment-editor">
                                            <form style="display: flex" action="{% url 'comments:post_comment' pk=answer.id %}" method="post">
                                                {% csrf_token %}
                                                <textarea class="form-control" placeholder="评论" rows="1" name="content" required></textarea>
                                                <input name="reply_id" value="" type="hidden">
                                                <button class="Button Button-blue" style="margin-left: 10px; width: 80px;">评论</button>
                                            </form>
                                        </div>
                                    </div>

                                </div>
                            {% endfor %}
                            {% if answers.has_next %}
                                <button class="Button Button-white get-more" onclick="answersMore(this, {{ answers.next_page_number }})">更多</button>
                            {% endif %}
                        </div>

                        {% elif AskView%}
                        <div class="card">
                            <div>
                                <a href="{% url 'users:answers' people.id %}" class="tab-link">回答 <span class="tab-num">{{ people.answers.count }}</span></a>
                                <a href="{% url 'users:asks' people.id %}" class="tab-link tab-active">提问 <span class="tab-num">{{ people.asks.count }}</span></a>
                                <a href="{% url 'users:collections' people.id %}" class="tab-link">收藏 <span class="tab-num">0</span></a>
                                <a href="{% url 'users:following' people.id %}" class="tab-link">关注 </a>
                            </div>
                            <div class="user-header">他的提问</div>
                            {% for ask in people.asks.all|dictsortreversed:'create_time' %}
                                <div style="border-top: solid 1px #f6f6f6">
                                    <div class="answer-ask-header"><a href="{% url 'asks:detail' ask.id %}" style="color: black">{{ ask.title }}</a></div>
                                    <div class="content-footer">{{ ask.create_time|date:'Y-m-d' }}&nbsp;·&nbsp;{{ ask.answers.count }}个回答</div>
                                </div>

                            {% endfor %}
                        </div>
                        {% elif CollectionView %}
                        <div class="card">
                            <div>
                                <a href="{% url 'users:answers' people.id %}" class="tab-link">回答 <span class="tab-num">{{ people.answers.count }}</span></a>
                                <a href="{% url 'users:asks' people.id %}" class="tab-link">提问 <span class="tab-num">{{ people.asks.count }}</span></a>
                                <a href="{% url 'users:collections' people.id %}" class="tab-link tab-active">收藏 <span class="tab-num">0</span></a>
                                <a href="{% url 'users:following' people.id %}" class="tab-link">关注 </a>
                            </div>
                            <div class="user-header">他的收藏</div>

                        </div>
                        {% elif FollowingView %}
                        <div class="card">
                            <div>
                                <a href="{% url 'users:answers' people.id %}" class="tab-link">回答 <span class="tab-num">{{ people.answers.count }}</span></a>
                                <a href="{% url 'users:asks' people.id %}" class="tab-link">提问 <span class="tab-num">{{ people.asks.count }}</span></a>
                                <a href="{% url 'users:collections' people.id %}" class="tab-link">收藏 <span class="tab-num">0</span></a>
                                <a href="{% url 'users:following' people.id %}" class="tab-link tab-active">关注 </a>
                            </div>
                            <div>
                                <a href="{% url 'users:following' people.id %}" class="tab-link follow-active">他关注的人</a>
                                <a href="{% url 'users:followers' people.id %}" class="tab-link">关注他的人</a>
                            </div>
                            {% for following in following_list %}
                                <div style="border-top: solid 1px #f6f6f6">
                                    <div class="answer-card-header" style="justify-content: space-between">
                                        <div style="display: flex">
                                            <img src="{{ following.get_image_url }}" class="img-rounded" width="38px" height="38px">
                                            <div class="user-info">
                                                <a href="{% url 'users:detail' following.id %}" class="user-name">{{ following.nickname }}</a>
                                                <div class="user-intro">{{ following.intro }}</div>
                                            </div>
                                        </div>
                                        {% if following != user %}
                                            {% if following.is_followed %}
                                                <a href="{% url 'users:unfollow' following.id %}">
                                                    <button class="Button Button-grey" onmouseenter="enter(this)" onmouseleave="leave(this)" style="float: right;width: 90px">已关注</button>
                                                </a>
                                            {% else %}
                                                <a href="{% url 'users:follow' following.id %}">
                                                    <button class="Button Button-blue" style="float: right;width: 90px"><i class="icon icon-plus"></i> 关注</button>
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>

                                </div>
                            {% endfor %}
                        </div>
                        {% elif FollowerView %}
                        <div class="card">
                            <div>
                                <a href="{% url 'users:answers' people.id %}" class="tab-link">回答 <span class="tab-num">{{ people.answers.count }}</span></a>
                                <a href="{% url 'users:asks' people.id %}" class="tab-link">提问 <span class="tab-num">{{ people.asks.count }}</span></a>
                                <a href="{% url 'users:collections' people.id %}" class="tab-link">收藏 <span class="tab-num">0</span></a>
                                <a href="{% url 'users:following' people.id %}" class="tab-link tab-active">关注 </a>
                            </div>
                            <div>
                                <a href="{% url 'users:following' people.id %}" class="tab-link">他关注的人</a>
                                <a href="{% url 'users:followers' people.id %}" class="tab-link follow-active">关注他的人</a>
                            </div>
                            {% for follower in followers_list %}
                                <div style="border-top: solid 1px #f6f6f6">

                                    <div class="answer-card-header" style="justify-content: space-between">
                                        <div style="display: flex">
                                            <img src="{{ follower.get_image_url }}" class="img-rounded" width="38px" height="38px">
                                            <div class="user-info">
                                                <a href="{% url 'users:detail' follower.id %}" class="user-name">{{ follower.nickname }}</a>
                                                <div class="user-intro">{{ follower.intro }}</div>
                                            </div>
                                        </div>
                                        {% if follower != user %}
                                            {% if follower.is_followed %}
                                                <a href="{% url 'users:unfollow' follower.id %}">
                                                    <button class="Button Button-grey" onmouseenter="enter(this)" onmouseleave="leave(this)" style="float: right;width: 90px">已关注</button>
                                                </a>
                                            {% else %}
                                                <a href="{% url 'users:follow' follower.id %}">
                                                    <button class="Button Button-blue" style="float: right;width: 90px"><i class="icon icon-plus"></i> 关注</button>
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}

                        </div>
                        {% endif %}

                    </div>

                    <div class="col-xs-4">
                        <div class="card">
                            <div class="col-xs-6" style="border-right: solid 1px #8590a6;">
                                <a href="{% url 'users:following' people.id %}">
                                <div class="follow-board">
                                    <div class="NumberBoard-itemname">关注了</div>
                                    <div class="NumberBoard-itemnum">{{ people.follow_list.count }}</div>
                                </div>
                                </a>

                            </div>
                            <div class="col-xs-6">
                                <a href="{% url 'users:followers' people.id %}">
                                <div class="follow-board">
                                    <div class="NumberBoard-itemname">关注者</div>
                                    <div class="NumberBoard-itemnum">{{ people.fun_list.count }}</div>
                                </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>


    </div>



{% endblock %}

{% block script %}
<script>
    function enter(x) {
        $(x).text('取消关注');
    }
    function leave(x) {
        $(x).text('  已关注');
    }
    function readmore(x, id) {
        var link = '/answers/' + id + '/content/';
        fetch(link, {
            method: 'GET',
            credentials: 'include'
        }).then(function (response) {
            return response.json()
        }).then(function (data) {
            if (!data.r) {
                $(x).siblings('span').hide();
                $(x).parent().html(data.content).append('<div class="answer-time">编辑于'+ data.create_time + '</p>');
            } else {
                alert('error!')
            }
        });
    }
    function reply(x, answer_id, comment_id) {
        var replyEeditor = $('#replyEditor-'+answer_id);
        $('.reply-btn').show();
        $(x).hide().before(replyEeditor);
        replyEeditor.show().find("input[name='reply_id']").val(comment_id);
    }
    function cancelReply(x) {
        $(x).parent().hide();
        $('.reply-btn').show();
    }
    function showComments(x, id) {
        $('#commentList-'+id).show();
        $(x).hide().next().show();
    }
    function hideComments(x, id) {
        $('#commentList-'+id).hide();
        $(x).hide().prev().show();
    }
    function voteUp(x, id) {
        {% if user.is_authenticated %}
        var link = '/answers/'+id+'/voteup/';
        fetch(link, {
            method: 'POST',
            credentials: 'include'
        }).then(function (response) {
            return response.json();
        }).then(function (data) {
            if (!data.r) {
                $(x).hide().next().show().html('<i class="icon icon-caret-up"></i> ' + data.count);
            } else {
                alert('error！')
            }
        });
        {% else %}
            window.location.href = '/login/';
        {% endif %}
    }
    function voteDown(x, id) {
        {% if user.is_authenticated %}
        var link = '/answers/'+id+'/votedown/';
        fetch(link, {
            method: 'POST',
            credentials: 'include'
        }).then(function (response) {
            console.log(response);
            return response.json();
        }).then(function (data) {
            console.log(data);
            if (!data.r) {
                $(x).hide().prev().show().html('<i class="icon icon-caret-up"></i> ' + data.count);
            } else {
                alert('error！')
            }
        });
        {% else %}
            window.location.href = '/login/';
        {% endif %}
    }
    function answersMore(x, page) {
        var link = '{% url 'users:answers' pk=people.id %}' + '?page=' + page;
        fetch(link, {
            method: 'GET',
            credentials: 'include'
        }).then(function (response) {
            if (response.ok) {
                return response.text();
            } else {
                throw new Error('404!')
            }
        }).then(function (data) {
            $('#answers-list').append(data);
            $(x).hide();
        }).catch(function (err) {
            console.log(err)
        });
    }

</script>
{% endblock %}